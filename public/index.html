<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <!--    <script src="../lib/d3.v5.min.js"></script>-->
    <!--    <script src="../lib/d3-dsv.min.js"></script>-->
    <!--    <script src="../lib/d3-fetch.min.js"></script>-->
    <script src="https://d3js.org/d3.v4.js"></script>
    <script src="lib/d3-tip.min.js"></script>
    <!--    <script src="https://d3js.org/d3.v3.min.js"></script>-->


    <link rel="stylesheet" href="index.css">
    <title>MOSSI-POLO</title>
</head>
<body>
<div id="heatmap_div"></div>
<!--<script src="index.js"></script>-->
<script>
    var margin = {top: 100, right: 100, bottom: 100, left: 100}
        , width = 1200 - margin.left - margin.right // Use the window's width
        , height = 650 - margin.top - margin.bottom; // Use the window's height

    var tip = d3.tip()
        .attr("class", "d3-tip")
        .offset([-8, 0])
        .html(function (d) {
            return d.file2.file_name.substr(0, d.file2.file_name.length - 5) + '<br>'
                + d.file1.file_name.substr(0, d.file1.file_name.length - 5) + '<br>'
                + 'Plagiarism: ' + d.file1.similarity_percent + '%'
                + '<br>' + 'Click me for details';
        });

    function addSVG() {
        svg = d3.select("#heatmap_div").append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom * 2)
            .append("g")
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")")
            .style("text-align", "center");

        return svg;
    }

    function generate_heatmap(svg) {
        d3.json("output/output2.json", function (error, data) {
            var fileNames = new Set();
            data.forEach(function (d) {
                fileNames.add(d.file1.file_name.substr(0, d.file1.file_name.length - 5));
                fileNames.add(d.file2.file_name.substr(0, d.file2.file_name.length - 5));
            });
            var xaxis = Array.from(fileNames);
            xaxis.sort();

            var padding = 0.02;
            // Build X scales and axis:
            var x = d3.scaleBand()
                .range([0, width - margin.left / 2])
                .domain(xaxis)
                .padding(padding);
            svg.append("g")
                .attr("transform", "translate(0," + (height - margin.bottom) + ")")
                .call(d3.axisBottom(x))
                .selectAll("text")
                .style("text-anchor", "end")
                .attr("dx", "2em")
                .attr("dy", "1.8em")
                .attr("transform", "rotate(-25)");

            // Build X scales and axis:
            var y = d3.scaleBand()
                .range([height - margin.bottom, 0])
                .domain(xaxis)
                .padding(padding);
            svg.append("g")
                .call(d3.axisLeft(y))
            ;

            // Build color scale
            var minimum = d3.min(data, function (d) {
                return d.file1.similarity_percent;
            });
            var maximum = d3.max(data, function (d) {
                return d.file1.similarity_percent;
            });
            var color_mossi_polo = d3.scaleLinear()
                .range(["#77bea7", "#1a2a25"])
                .domain([minimum, maximum]);

            svg.selectAll()
                .data(data, function (d) {
                    if (d.file1.file_name.localeCompare(d.file2.file_name) === 1) {
                        var temp = d.file1;
                        d.file1 = d.file2;
                        d.file2 = temp;
                    }
                    return d.file1.file_name.substr(0, d.file1.file_name.length - 5)
                        + ':' + d.file2.file_name.substr(0, d.file2.file_name.length - 5);
                })
                .enter()
                .append("a")
                .attr("xlink:href", "http://moss.stanford.edu/results/956166494/")
                .append("rect")
                .attr("x", function (d) {
                    return x(d.file1.file_name.substr(0, d.file1.file_name.length - 5))
                })
                .attr("y", function (d) {
                    return y(d.file2.file_name.substr(0, d.file2.file_name.length - 5))
                })
                .attr("width", x.bandwidth())
                .attr("height", y.bandwidth())
                .style("fill", function (d) {
                    return color_mossi_polo(d.file1.similarity_percent)
                })
                .on("mouseover", tip.show)
                .on("mouseout", tip.hide);

            // Add non mossi-polo plagiarised version
            d3.json("output/output1.json", function (error, ds) {
                svg.selectAll()
                    .data(ds, function (d) {
                        if (d.file1.file_name.localeCompare(d.file2.file_name) === 1) {
                            var temp = d.file1;
                            d.file1 = d.file2;
                            d.file2 = temp;
                        }
                        // console.log(d.file2.file_name +':'+ d.file1.file_name);
                        return d.file2.file_name.substr(0, d.file2.file_name.length - 5)
                            + ':' + d.file1.file_name.substr(0, d.file1.file_name.length - 5);
                    })
                    .enter()
                    .append("a")
                    .attr("xlink:href", "http://moss.stanford.edu/results/956166494/")
                    .append("rect")
                    .attr("x", function (d) {
                        return x(d.file2.file_name.substr(0, d.file2.file_name.length - 5))
                    })
                    .attr("y", function (d) {
                        return y(d.file1.file_name.substr(0, d.file1.file_name.length - 5))
                    })
                    .attr("width", x.bandwidth())
                    .attr("height", y.bandwidth())
                    .style("fill", function (d) {
                        return color_mossi_polo(d.file1.similarity_percent)
                    })
                    .on("mouseover", tip.show)
                    .on("mouseout", tip.hide);
            });
            addLegend(svg, minimum + '%', '' + maximum + '%');
        });
    }

    function handleMouseOver() {
        console.log("hello");
    }

    function addLegend(svg, min, max) {
        // Create the svg:defs element and the main gradient definition.
        var svgDefs = svg.append('defs');

        var mainGradient = svgDefs.append('linearGradient')
            .attr('id', 'mainGradient');

        // Create the stops of the main gradient. Each stop will be assigned
        // a class to style the stop using CSS.
        mainGradient.append('stop')
            .attr('stop-color', '#77bea7')
            .attr('offset', '0');

        mainGradient.append('stop')
            .attr('stop-color', '#1a2a25')
            .attr('offset', '1');

        // Use the gradient to set the shape fill, via CSS.
        svg.append('rect')
            .attr('x', width / 4 - margin.left / 2)
            .attr('y', height - margin.bottom / 4)
            .attr('width', width / 2)
            .attr('height', 15)
            .attr('fill', 'url(#mainGradient)');

        svg.append("text")
            .attr("x", width / 4 - margin.left / 2)
            .attr("y", height - margin.bottom / 4 - 5)
            .style("font-size", "14px")
            .text(min);
        svg.append("text")
            .attr("x", width / 4 - margin.left / 2 + width / 2 - 25)
            .attr("y", height - margin.bottom / 4 - 5)
            .style("font-size", "14px")
            .text(max);

    }

    var svg = addSVG();
    svg.call(tip);
    generate_heatmap(svg);
</script>
<!--    <script src="https://d3js.org/d3.v3.min.js"></script>-->
<!--    <script>-->

<!--    var margin = {top: 20, right: 20, bottom: 30, left: 40},-->
<!--        width = 960 - margin.left - margin.right,-->
<!--        height = 500 - margin.top - margin.bottom;-->

<!--    var x0 = d3.scale.ordinal()-->
<!--        .rangeRoundBands([0, width], .1);-->

<!--    var x1 = d3.scale.ordinal();-->

<!--    var y = d3.scale.linear()-->
<!--        .range([height, 0]);-->

<!--    var xAxis = d3.svg.axis()-->
<!--        .scale(x0)-->
<!--        .tickSize(0)-->
<!--        .orient("bottom");-->

<!--    var yAxis = d3.svg.axis()-->
<!--        .scale(y)-->
<!--        .orient("left");-->

<!--    var color = d3.scale.ordinal()-->
<!--        .range(["#ca0020","#f4a582","#d5d5d5","#92c5de","#0571b0"]);-->

<!--    var svg = d3.select('body').append("svg")-->
<!--        .attr("width", width + margin.left + margin.right)-->
<!--        .attr("height", height + margin.top + margin.bottom)-->
<!--      .append("g")-->
<!--        .attr("transform", "translate(" + margin.left + "," + margin.top + ")");-->

<!--    d3.json("output_processed.json", function(error, data) {-->

<!--      var categoriesNames = data.map(function(d) { return d.categorie; });-->
<!--      var rateNames = data[0].values.map(function(d) { return d.rate; });-->

<!--      x0.domain(categoriesNames);-->
<!--      x1.domain(rateNames).rangeRoundBands([0, x0.rangeBand()]);-->
<!--      y.domain([0, d3.max(data, function(categorie) { return d3.max(categorie.values, function(d) { return d.value; }); })]);-->

<!--      svg.append("g")-->
<!--          .attr("class", "x axis")-->
<!--          .attr("transform", "translate(0," + height + ")")-->
<!--          .call(xAxis);-->

<!--      svg.append("g")-->
<!--          .attr("class", "y axis")-->
<!--          .style('opacity','0')-->
<!--          .call(yAxis)-->
<!--      .append("text")-->
<!--          .attr("transform", "rotate(-90)")-->
<!--          .attr("y", 6)-->
<!--          .attr("dy", ".71em")-->
<!--          .style("text-anchor", "end")-->
<!--          .style('font-weight','bold')-->
<!--          .text("Value");-->

<!--      svg.select('.y').transition().duration(500).delay(1300).style('opacity','1');-->

<!--      var slice = svg.selectAll(".slice")-->
<!--          .data(data)-->
<!--          .enter().append("g")-->
<!--          .attr("class", "g")-->
<!--          .attr("transform",function(d) { return "translate(" + x0(d.categorie) + ",0)"; });-->

<!--      slice.selectAll("rect")-->
<!--          .data(function(d) { return d.values; })-->
<!--      .enter().append("rect")-->
<!--          .attr("width", x1.rangeBand())-->
<!--          .attr("x", function(d) { return x1(d.rate); })-->
<!--          .style("fill", function(d) { return color(d.rate) })-->
<!--          .attr("y", function(d) { return y(0); })-->
<!--          .attr("height", function(d) { return height - y(0); })-->
<!--          .on("mouseover", function(d) {-->
<!--              d3.select(this).style("fill", d3.rgb(color(d.rate)).darker(2));-->
<!--          })-->
<!--          .on("mouseout", function(d) {-->
<!--              d3.select(this).style("fill", color(d.rate));-->
<!--          });-->

<!--      slice.selectAll("rect")-->
<!--          .transition()-->
<!--          .delay(function (d) {return Math.random()*1000;})-->
<!--          .duration(1000)-->
<!--          .attr("y", function(d) { return y(d.value); })-->
<!--          .attr("height", function(d) { return height - y(d.value); });-->

<!--      //Legend-->
<!--      var legend = svg.selectAll(".legend")-->
<!--          .data(data[0].values.map(function(d) { return d.rate; }).reverse())-->
<!--      .enter().append("g")-->
<!--          .attr("class", "legend")-->
<!--          .attr("transform", function(d,i) { return "translate(0," + i * 20 + ")"; })-->
<!--          .style("opacity","0");-->

<!--      legend.append("rect")-->
<!--          .attr("x", width - 18)-->
<!--          .attr("width", 18)-->
<!--          .attr("height", 18)-->
<!--          .style("fill", function(d) { return color(d); });-->

<!--      legend.append("text")-->
<!--          .attr("x", width - 24)-->
<!--          .attr("y", 9)-->
<!--          .attr("dy", ".35em")-->
<!--          .style("text-anchor", "end")-->
<!--          .text(function(d) {return d; });-->

<!--      legend.transition().duration(500).delay(function(d,i){ return 1300 + 100 * i; }).style("opacity","1");-->

<!--    });-->

<!--    </script>-->

<script>
console.log("links1");
d3.json("../links.json", function(error, data) {

  var links = data.map(function(d) { return d; });
  var nodes = {};

  console.log("links");
  console.log(links);

  // Compute the distinct nodes from the links.
  links.forEach(function(link) {
      link.source = nodes[link.source] ||
          (nodes[link.source] = {name: link.source});
      link.target = nodes[link.target] ||
          (nodes[link.target] = {name: link.target});
  });

  var width = 1200,
      height = 700;

  var force = d3.forceSimulation()
      .nodes(d3.values(nodes))
      .force("link", d3.forceLink(links).distance(100))
      .force('center', d3.forceCenter(width / 2, height / 2))
      .force("x", d3.forceX())
      .force("y", d3.forceY())
      .force("charge", d3.forceManyBody().strength(-5050))
      .alphaTarget(1)
      .on("tick", tick);

  var svg = d3.select("body").append("svg")
      .attr("width", width)
      .attr("height", height);

  // add the links and the arrows
  var path = svg.append("g")
  .selectAll("path")
  .data(links)
  .enter()
  .append("path")
  .filter(function(d) {return d.value > 50;})
  .attr("class", function(d) { return "link " + d.type; })
  .style("stroke", linkColour)
  .style("stroke-dasharray", linkDash)
  .style("stroke-width", linkWidth);

  var myColor = d3.scaleLinear().domain([1,10])
    .range(["#cfa461","#362b1a"]);

  // define the nodes
  var node = svg.selectAll(".node")
      .data(force.nodes())
    .enter().append("g")
      .attr("class", "node")
      .call(d3.drag()
        .on("start", dragstarted)
        .on("drag", dragged)
        .on("end", dragended)
        );

  // add the nodes
  node.append("circle")
      .attr("r",function(d) {
  		d.weight = path.filter(function(l) {
  			return l.source.index == d.index || l.target.index == d.index
  		}).size();
  		var minRadius = 2;
  		return minRadius + (d.weight*2);
     	})
     	.style("fill", function(d){return myColor(d.weight) })
     	.classed("fixed", false)
     	.on("dblclick", dblclick);

  // add the labels
  node.append("text")
      .attr("dx", 15)
      .attr("dy", "-1em")
      .text(function(d) { return d.name });

// add the curvy lines
function tick() {
    path.attr("d", function(d) {
        var dx = d.target.x - d.source.x,
            dy = d.target.y - d.source.y,
            dr = Math.sqrt(dx * dx + dy * dy);
        return "M" +
            d.source.x + "," +
            d.source.y + "A" +
            dr + "," + dr + " 0 0,1 " +
            d.target.x + "," +
            d.target.y;
    });

    node
        .attr("transform", function(d) {
        return "translate(" + d.x + "," + d.y + ")"; })

    // make labels also move with node
    node.attr('transform', d => `translate(${d.x},${d.y})`);
};

function dragstarted(d) {
      if (!d3.event.active) force.alphaTarget(0.3).restart();
      d.fx = d.x;
      d.fy = d.y;
    };

function dragged(d) {
  d.fx = d3.event.x;
  d.fy = d3.event.y;
};

function dragended(d) {
  if (!d3.event.active) force.alphaTarget(0);
  if (d.fixed == true){
     d.fx = d.x;
     d.fy = d.y;
  }
  else{
    d.fx = null;
    d.fy = null;
  }

};

function linkColour(d){
  console.log(d.value);
  // console.log(linkColors(d.value);
	if(d.value <50){
		return "transparent";
	} else if(d.value <60) {
		return "#8bcc62";
	}else if(d.value <70){
    return "#567d3d";
  } else {
    return "#1b2614";
  }
  // return linkColors(d.value);
};

function linkWidth(d){
	if(d.value == 0){
		return 1;
	} else {
		return 3;
	}
};

function linkDash(d){
	if(d.value == 0){
		return "10,3";
	} else {
		return "0,0";
	}
};

function dblclick(d) {
	if(d.fixed==true){
		d3.select(this).classed("fixed", d.fixed = false)
		.style("fill", function(d){return myColor(d.weight) });
	} else {
		d3.select(this).classed("fixed", d.fixed = true).style("fill", "#cf6c61" );

	}
	if (d.fixed == true){
	    d.fx = d.x;
	    d.fy = d.y;
	}
  	if (d.fixed == false){
     	d.fx = null;
     	d.fy = null;
 	}
}

});
</script>

</body>
</html>